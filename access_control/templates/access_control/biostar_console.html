{% extends "common/base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>BioStar 2 - Consola</h3>
    <div class="d-flex gap-2">
      <button id="sync-devices" class="btn btn-primary btn-sm">Sincronizar lectores</button>
      <button id="sync-users" class="btn btn-secondary btn-sm">Sincronizar personas</button>
    </div>
  </div>

  <div id="msg" class="alert d-none" role="alert"></div>

  <div class="row">
    <div class="col-lg-6">
      <h5>Lectores</h5>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>IP</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Sync</th>
            </tr>
          </thead>
          <tbody id="devices-body"></tbody>
        </table>
      </div>
    </div>

    <div class="col-lg-6">
      <h5>Personas</h5>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>ID BioStar</th>
              <th>Email</th>
              <th>Tel</th>
              <th>Sync</th>
            </tr>
          </thead>
          <tbody id="users-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  function showMsg(text, kind) {
    const el = document.getElementById("msg");
    el.className = "alert alert-" + (kind || "info");
    el.textContent = text;
    el.classList.remove("d-none");
    setTimeout(() => el.classList.add("d-none"), 4000);
  }

  function statusBadge(status) {
    // Ajustable: si BioStar usa 0/1/2, esto te da una UI clara
    if (status === 1) return '<span class="badge bg-success">Conectado</span>';
    if (status === 0) return '<span class="badge bg-danger">Desconectado</span>';
    if (status === 2) return '<span class="badge bg-warning text-dark">Sync err</span>';
    return '<span class="badge bg-secondary">N/A</span>';
  }

  async function fetchJSON(url, options) {
    const resp = await fetch(url, {
      credentials: "same-origin",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      ...options
    });
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    return await resp.json();
  }

  function getCookie(name) {
    const v = document.cookie.split(";").map(s => s.trim()).find(s => s.startsWith(name + "="));
    return v ? decodeURIComponent(v.split("=")[1]) : "";
  }

  async function loadDevices() {
    const data = await fetchJSON("/api/biostar/devices/");
    const body = document.getElementById("devices-body");
    body.innerHTML = data.map(d => `
      <tr>
        <td>${d.name || ""}</td>
        <td>${d.ip_addr || ""}</td>
        <td>${d.device_type || ""}</td>
        <td>${statusBadge(d.status)}</td>
        <td>${(d.last_synced_at || "").replace("T", " ").slice(0,19)}</td>
      </tr>
    `).join("");
  }

  async function loadUsers() {
    const data = await fetchJSON("/api/biostar/users/");
    const body = document.getElementById("users-body");
    body.innerHTML = data.map(u => `
      <tr>
        <td>${u.name || ""}</td>
        <td>${u.user_unique_id || u.user_id}</td>
        <td>${u.email || ""}</td>
        <td>${u.phone || ""}</td>
        <td>${(u.last_synced_at || "").replace("T", " ").slice(0,19)}</td>
      </tr>
    `).join("");
  }

  document.getElementById("sync-devices").addEventListener("click", async () => {
    try {
      showMsg("Sincronizando lectores...", "info");
      await fetchJSON("/api/biostar/devices/sync/", { method: "POST" });
      await loadDevices();
      showMsg("Lectores sincronizados ✅", "success");
    } catch (e) {
      showMsg("Error sincronizando lectores: " + e.message, "danger");
    }
  });

  document.getElementById("sync-users").addEventListener("click", async () => {
    try {
      showMsg("Sincronizando personas...", "info");
      await fetchJSON("/api/biostar/users/sync/", { method: "POST" });
      await loadUsers();
      showMsg("Personas sincronizadas ✅", "success");
    } catch (e) {
      showMsg("Error sincronizando personas: " + e.message, "danger");
    }
  });

  // Carga inicial
  Promise.all([loadDevices(), loadUsers()]).catch(e => showMsg("Error cargando datos: " + e.message, "danger"));
})();
</script>
{% endblock %}
